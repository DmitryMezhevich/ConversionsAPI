<script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>

<script type="module">
    import { v4 as uuidv4 } from 'https://jspm.dev/uuid';

    window.getUUIDv4 = function () {
        return uuidv4();
    };
</script>

<script>
    $(document).ready(function () {
        $('#allrecords').data('fb-event', 'nosend');
    });
</script>

<script>
    const url = new URL(window.location.href);
    const params = url.searchParams;

    const sourceFB = params.has('fbclid');
    const sourceTT = params.has('ttclid');
    const utmSource = params.has('utm_source')
        ? params.get('utm_source')
        : 'отсутствует';
    const originlURL = `${url.hostname}${url.pathname}`;
</script>

<!-- ///////////////////////////////////////////////////////////////////////////// -->

<script>
    function getCookie(name) {
        var decodedCookie = decodeURIComponent(document.cookie);
        var cookies = decodedCookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.indexOf(name + '=') === 0) {
                return cookie.substring(name.length + 1);
            }
        }
        return null;
    }

    function setCookie(name) {
        var currentDate = new Date();
        var expirationDate = new Date(
            currentDate.getTime() + 60 * 24 * 60 * 60 * 1000
        );
        var expires = 'expires=' + expirationDate.toUTCString();
        const _eventID = window.getUUIDv4();
        document.cookie = `${name}=${_eventID}; ${expires}; path=/`;
        return _eventID;
    }

    function sendEventToFB(name = null, phone = null) {
        const eventName = phone ? 'Purchase' : 'PageView';
        const customData =
            eventName === 'Purchase' ? { value: 0.0, currency: 'USD' } : {};
        fbq('track', `${eventName}`, customData, {
            eventID: eventID,
        });

        const eventModule = {
            fbPixelID: fbPixelID,
            eventName: eventName,
            eventSourceUrl: window.location.href,
            eventID: eventID,
            fbc: getCookie('_fbc'),
            fbp: getCookie('_fbp'),
            name: name,
            phone: phone,
        };

        sendEvent(
            `https://api-planetshop.online/eventManager/${eventName}Event`,
            eventModule
        );
    }

    function sendEventToTT(name = null, phone = null) {}

    function sendEvent(url, data) {
        axios.post(url, data, {
            headers: {
                'Content-Type': 'application/json',
            },
        });
    }
</script>

<!-- ///////////////////////////////////////////////////////////////////////////// -->

<script>
    let eventID = '';
    window.addEventListener('load', function (event) {
        eventID = getCookie('_plEventID');
        if (eventID === null) {
            eventID = setCookie('_plEventID');
        }

        if (sourceFB) {
            sendEventToFB();
        } else if (sourceTT) {
            sendEventToTT();
        }
    });
</script>

<script>
    function t396_onSuccess(form) {
        if (!form) return;

        if (form instanceof jQuery) {
            form = form.get(0);
        }

        const obj = {};
        const inputs = form.elements;
        Array.prototype.forEach.call(inputs, function (input) {
            obj[input.name] = input.value;
        });

        const complectVariants = document.querySelectorAll('.complect-variant');
        let selectedVariant = null;
        complectVariants.forEach(function (complectVariant) {
            if (complectVariant.classList.contains('active')) {
                selectedVariant = complectVariant;
            }
        });
        const pack = selectedVariant.getAttribute('pack');

        const data = {
            originlURL: String(originlURL),
            source: String(utmSource),
            product: String(obj['product']),
            image: String(obj['photo']),
            name: String(obj['name']),
            phone: String(obj['phone']),
            count: String(pack),
            price: String(
                String(pack) === '1' ? obj['price_1'] : obj['price_2']
            ),
        };

        if (sourceFB) {
            sendEventToFB(data.name, data.phone);
        } else if (sourceTT) {
            sendEventToTT();
        }

        let message = '';

        message += `<b>Ссылка: ${data.originlURL}</b>\n`;
        message += `<b>Источник: ${data.source}</b>\n`;
        message += `<b>Товара: ${data.product}</b>\n`;
        message += `<b>Фото: ${data.image}</b>\n`;
        message += `<b>Имя клиента: ${data.name}</b>\n`;
        message += `<b>Телефон: ${data.phone}</b>\n`;
        message += `<b>Количество: ${data.count}</b>\n`;
        message += `<b>Цена: ${data.price} руб.</b>\n`;

        const TOKEN = '5999844731:AAHdjkC06i3wNPmRnOjehw9QbQ0U8gs13-I';
        const CHAT_ID = '-1001646373201';
        const URI_API = `https://api.telegram.org/bot${TOKEN}/sendMessage`;

        axios
            .post(URI_API, {
                chat_id: CHAT_ID,
                parse_mode: 'html',
                text: message,
            })
            .then(() => {
                window.location.href = 'https://planetshop.by/good';
            })
            .catch(() => {});
    }
</script>

<!-- ///////////////////////////////////////////////////////////////////////////// -->
