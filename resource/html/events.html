<!--
    Трекеры для создания ивентов и их отправки напрямую и в Event API
-->

<script>
    // По завершению загрузки страницы формируем EventID и вызываем ивент PageView
    window.addEventListener('load', function (event) {
        // Добавляем действие на кнопку в popup при не удачном закезе
        addListenerResendOrder()

        eventID = eventID ? getCookie('_plEventID') : eventID;
        if (eventID === null) {
            eventID = setCookieEventID();
        }

        if (sourceFB) {
            sendEventToFB();
        } else if (sourceTT) {
            sendEventToTT();
        }
    });

    // По нажатию кнопки на форме вытаскиваем значение имени и телефона
    // вызываем ивент покупки и отправляем заявку в telegram
    function t396_onSuccess(form) {
        // Достаем значения из формы
        if (!form) return;

        // Открываем окно с ожиданием
        openPopUp('loading');

        if (form instanceof jQuery) {
            form = form.get(0);
        }

        const obj = {};
        const inputs = form.elements;
        Array.prototype.forEach.call(inputs, function (input) {
            obj[input.name] = input.value;
        });

        // Достаем значения из варианта комплектации товара
        const complectVariants = document.querySelectorAll('.complect-variant');
        let selectedVariant = null;
        complectVariants.forEach(function (complectVariant) {
            if (complectVariant.classList.contains('active')) {
                selectedVariant = complectVariant;
            }
        });
        const pack = selectedVariant.getAttribute('pack');
        const price = selectedVariant.getAttribute('price');

        // Формируем дополнительный параметр источника для лучшей читабельности
        // в сообщении telegram
        const sourceDescription = sourceFB ? ' (Facebook)' : (sourceTT ? ' (TikTok)' : '');

        // Формируем общий объект с данными заказа
        const data = {
            originlURL: String(originlURL),
            source: String(utmSource),
            sourceDescription: String(sourceDescription),
            product: String(nameOfProduct),
            image: String(srcImg),
            name: String(obj['name']),
            phone: String(obj['phone']),
            messageDescription: String(messageDescription),
            count: String(pack),
            price: String(price),
        };

        // Отправляем события в Pixel
        if (sourceFB) {
            sendEventToFB(data.name, data.phone);
        } else if (sourceTT) {
            sendEventToTT(data.phone);
        }

        // Формируем сообщение для telegram
        let message = '';
        message += `<b>Фото: ${data.image}</b>\n`;
        message += `<b>Ссылка: ${data.originlURL}</b>\n`;
        message += `<b>Источник: ${data.source}${data.sourceDescription}</b>\n`;
        message += `<b>Товара: ${data.product}</b>\n`;
        message += `<b>Имя клиента: ${data.name}</b>\n`;
        message += `<b>Телефон: ${data.phone}</b>\n`;
        message += `<b>${data.messageDescription}: ${data.count}</b>\n`;
        message += `<b>Цена: ${data.price} руб.</b>\n`;

        // Отправка в telegram
        sendOrder();
    }
</script>